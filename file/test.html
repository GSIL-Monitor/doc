
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>消息中间件MetaQ高性能原因分析</title>
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=1100, maximum-scale=1.0, user-scalable=yes"/>
  <link rel="stylesheet" href="/assets/app-2525f05fd8e8ba68539fd96309305dd73e5549a8.css">
  <script src="/assets/app-97ad868fdc01a84efd6290132048872eb24c252c.js" data-main="article/show"></script>
  <script>require('main')</script>
  <!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.0.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
  <![endif]-->
        <base target="_blank"/>
  </head>
<body class="" cnzz_category="文章详情">

      <header>
  <style>
    .navbar-nav>li {margin-right: 5px;}
  </style>
  <div class="navbar navbar-default">
    <div class="container">
      <ul class="nav navbar-nav">
        <li><a href="/square/">首页</a></li>
        <li><a href="/articles/?sort=yuan">文章</a></li>
        <li><a href="/ask">问答</a></li>
                <li><a href="/tool/">百宝箱</a></li>
        <li><a href="http://wiki.atatech.org">Wiki</a></li>
        <li class="divider"></li>
        <li><a href="/groups/">圈子</a></li>
        <li><a href="/teams/">团队博客</a></li>
        <li><a href="/activity/">活动</a></li>
        <li><a href="/conference/">会议</a></li>
        <li><a href="/techtalk/">对话科技</a></li>
        <li class="divider"></li>
                <li><a href="/databoard/" target="_blank">数据看板</a></li>
                        <li class="li-margin"><a class="red" href="/publication" target="_blank">技术月刊&精华沉淀</a></li>
              </ul>
      <ul class="nav navbar-nav pull-right">

                                <li><a target="_self" href="/notifications/">消息            <em class="label label-danger">29</em></a></li>
        <li><a target="_self" href="/feed/">动态</a></li>
        <li class="divider"></li>
        <li class="dropdown">
          <a target="_self" href="/users/131096#information" class="navbar-avatar" data-toggle="dropdown">
            <img           src="http://img3.tbcdn.cn/L1/461/1/u_identicon_21e3421b828551f99142364273136912.png_40x40" width="20" height="20"
   alt="蒙可" class="img-circle">
            <span>&nbsp;蒙可</span>
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li>
              <a target="_self" href="/users/131096/own#information">
                <span class="glyphicon glyphicon-edit"></span>
                <span>我的文章</span>
              </a>
            </li>
            <li>
              <a target="_self" href="/activity/new">
                <span class="glyphicon glyphicon-fire"></span>
                <span>发起活动</span>
              </a>
            </li>
            <li>
              <a target="_self" href="/users/131096/ask#information">
                <span class="glyphicon glyphicon-question-sign"></span>
                <span>我的问题</span>
              </a>
            </li>
            <li>
              <a target="_self" href="/users/131096/mark#information">
                <span class="glyphicon glyphicon-star-empty"></span>
                <span>我的收藏</span>
              </a>
            </li>
            <li>
              <a target="_self" href="/users/131096/groups">
                <span class="glyphicon glyphicon-record"></span>
                <span>我的圈子</span>
              </a>
            </li>
            <li>
              <a target="_self" href="/teams">
                <span class="glyphicon glyphicon-list-alt"></span>
                <span>我的博客</span>
              </a>
            </li>

                                                                                                                                    <li>
              <a target="_self" href="/settings/">
                <span class="glyphicon glyphicon-cog"></span>
                <span>个人设置</span>
              </a>
            </li>
                        <li class="divider"></li>
            <li>
              <a target="_self" href="/logout" data-method="post">
                <span class="glyphicon glyphicon-log-out"></span>
                <span>退出</span>
              </a>
            </li>
          </ul><!-- /.dropdown -->
        </li>
        <li class="dropdown quick-search">
          <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            <span class="glyphicon glyphicon-search"></span></button>
          <div class="dropdown-menu form-group" role="menu">
            <form target="_self" action="/search" method="get" class="quick-form js-active-on-valid">
              <input type="hidden" name="type" value="ARTICLE"/>
              <input type="text" name="q" class="form-control" placeholder="全站搜索" required>
              <button type="submit" class="quick_btn"></button>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>

  </header>    <div class="container header-notice-container">
      </div>
  <style>
    .content table td, .content table th{
      word-break: break-all;
      word-wrap:break-word;
    }
    .content table tr:nth-child(2n) {
      background-color: #f6f8fa;
    }
    .influential-article{
      background: url(http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/5536328776615091af700516adbe8319.png);
      background-size: 200px 200px;
      width: 200px;
      height: 200px;
      position: absolute;
      right: 174px;
      top: 127px;
      z-index: 5000;
    }

    .article-anchor {float: left;line-height:1.5;margin-left: -20px;padding-right: 4px;position:absolute;}
    .article-anchor:hover{cursor: pointer;}
    .article-anchor .ancher-link {visibility:hidden;}
    .medal {margin-left: -12px; margin-right: 5px;}
    .medal-show {display: inline-block;position: absolute; background-color: #fe4625;border-radius: 0.25em; line-height: 25px;}
    .medal-show span {color: #fff;padding: 10px;}
    .medal-hide {display: none;position: absolute}
    .medal-show:after {
      border-color: #f0f0f0 transparent transparent #f0f0f0;
      border-style: solid solid solid solid;
      border-width: 6px 3px;

      /* 必指定，才能@示热 */
      content: '';

      height: 0px;
      left: 0px;

      /* 必指定，否t梯形 */
      position: absolute;
      top: 25px;
      width: 0px;
    }
    .medal-show:before {
      border-color: #fe4625 transparent transparent #fe4625;
      border-style: solid solid solid solid;
      border-width: 6px 10px;

      /* 必指定，才能@示热 */
      content: '';

      height: 0px;
      left: 0px;

      /* 必指定，否t梯形 */
      position: absolute;

      top: 25px;
      width: 0px;
    }
    .pull-right .article-favor, .article-favor, .article-delete {
      margin-left: 10px;
    }

    .article-tag {
      margin-right: 5px;
      color: #999999;
    }

    .knowledge-tags a {
      margin-right: 8px;
      color: #999999;
    }

    .knowledge-tags a:hover {
      color: #428bca;
      text-decoration: underline;
    }

    .labels span, .labels a {
      font-size: 13px;
    }
    .labels div span, .labels .knowledge-tags span, .span-weight {
      font-weight: 700;
      color: #666;
    }

    .article-title {
      text-align: center;
      border-bottom: #dfdfdf 1px solid;
      margin-bottom: 10px;
      padding-bottom: 15px;
    }

    .special-attr {
      color: #FF3300;
      margin-right: 10px;
      font-weight: 700;
    }

    .special-yuan {
      color: #009933 !important;
    }

  </style>
  
    <div class="container">
    <div class="_article-container">
      <div class="_article-box" role="main">
        <article class="_article">
          <header class="heading">
            <div class="infos clearfix">
              <a href="/users/65561" class="info" title="傅冲"><img           src="http://img3.tbcdn.cn/L1/461/1/u_identicon_fe11d41c342e5325fca2d2ca407828f0.png_80x80" width="32" height="32"
   alt="傅冲" class="img-user"><span>&nbsp;傅冲</span></a>                            <span class="info">
                              <time class="" datetime="2016-03-02T22:06:43+08:00">2016-03-02 22:06:43</time>
                              </span>
                                                            <span class="info">
                  发表于：
                  <a href="/teams/183">网商银行技术博客</a>
                                      <span>&gt;&gt;</span>
                    <a href="/teams/183?cid=864">Java技术</a>
                                  </span>
              
              <div class="pull-right">
                <span class="info">1101  阅读</span>
                <span id="tools_favor_top" class="article-favor">
                  <a data-toggle="modal" href="/articles/50240/mark/" data-target="#my-mark-modal" title="收藏" class="btn btn-default item-tomark" role="button" rel="nofollow" >
                    42&nbsp;<span>收藏</span>
                  </a>
                  <a href="/articles/50240/unmark" title="取消收藏" class="btn btn-primary item-tounmark" role="button" rel="nofollow" data-remote="true" data-done="$(this).prev().addBack().toggle()" data-method="post" style="display:none">
                    43&nbsp;<span>取消收藏</span>
                  </a>
                </span>
                
                              </div>
            </div>

            
            <div class="labels">
  <div class="knowledge-tags">
    <span class="k-span">知识体系：</span>
          <a class="ktag" href="/articles/?kid=6" data-kid="6">操作系统</a>
          <a class="ktag" href="/articles/?kid=16" data-kid="16">软件研发工具</a>
          <a class="ktag" href="/articles/?kid=21" data-kid="21">基础中间件</a>
        <button href="/knowledge/knowledgeTags?type=show&aid=50240" class="btn btn-default btn-xs kbutton" data-toggle="modal" data-target="#editKnowledgeTagModal">
      <span class="glyphicon glyphicon-pencil"></span>
      修改知识体系
    </button>
  </div>
</div>

  <div class="modal fade" id="editKnowledgeTagModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div>

            <div class="labels">
    <form target="_self" accept-charset="UTF-8" action="/articles/50240/tags" autocomplete="off" method="post"
    data-remote="true"
    data-done="$(this).closest('.labels').replaceWith(r);$.alert('修改成功', 'success')"
    style="display:none">
    <input type="hidden" name="_method" value="put">
    <div class="form-group">
      <input type="text" name="tags" class="form-control js-tag-complete" value="Java核心技术 分布式系统与计算 Metaq 中间件系列 ">
    </div>
    <div class="form-group text-right">
      <button type="button" class="btn btn-default btn-sm" onclick="$(this).closest('.labels').children().toggle()">取消</button>
      <button type="submit" class="btn btn-primary btn-sm">更新</button>
    </div>
  </form>
  
  <div>
    <span>文章标签：</span>
          <a class="article-tag" href="/search?q=Java核心技术&type=INSIDE_ARTICLE_TAG">Java核心技术</a>
          <a class="article-tag" href="/search?q=分布式系统与计算&type=INSIDE_ARTICLE_TAG">分布式系统与计算</a>
          <a class="article-tag" href="/search?q=Metaq&type=INSIDE_ARTICLE_TAG">Metaq</a>
          <a class="article-tag" href="/search?q=中间件系列&type=INSIDE_ARTICLE_TAG">中间件系列</a>
              <button type="button" id="edit-tags" class="btn btn-default btn-xs" onclick="$(this).closest('.labels').children().toggle()">
        <span class="glyphicon glyphicon-pencil"></span>
        修改标签
      </button>
      <a href="/articles/50240/tags/history" class="btn btn-default btn-xs" data-toggle="modal" data-target="#modal-tag-history">
        <span class="glyphicon glyphicon-time"></span>
        标签历史
      </a>
      </div>
</div>

                          <div class="labels">
                <span class="span-weight">附加属性：</span>
                                                  <span class="special-attr special-yuan">作者原创</span>
                                                                                                              </div>
            
            
                      </header>

            <div class="article-title">
              <h1 class="title clearfix unsafe">
                消息中间件MetaQ高性能原因分析
                              </h1>
            </div>

          <div class="content unsafe" style="background: rgba(0, 0, 0, 0) url(/public/watermark.png) repeat scroll 0 0">
                          <h2>简介</h2>
<p>前面写了关于文件系统的三篇文章，<a href="http://www.atatech.org/articles/46933">深入浅出文件系统</a>，<a href="http://www.atatech.org/articles/47555">文件系统之读写基础篇</a>，<a href="http://www.atatech.org/articles/47927">文件系统之读写高级篇</a>，此篇算是对文件系统相关文章的一个总结。</p>
<p><code>MetaQ</code>是一款高性能的消息中间件，经过几年的发展，已经非常成熟稳定，历经多年双11的零点峰值压测，表现堪称完美。</p>
<p><code>MetaQ</code>当前最新最稳定的稳本是<code>3.x</code>系统，<code>MetaQ 3.x</code>重新设计和实现，比之前的版本更优秀。虽然<code>MetaQ</code>借鉴了<code>linkedin</code> 的消息中间件<code>kafak</code>思想，但已经是青出于蓝而胜于蓝。</p>
<p>本文不对<code>MetaQ</code>做全面的介绍，只选择高性能这点来分析。</p>
<h3>性能测试对比图</h3>
<p><a href="http://img3.tbcdn.cn/L1/461/1/82d251d8e2dc68e6c63874904165ed5dbf8377c2.png" target="_blank"><img src="http://img3.tbcdn.cn/L1/461/1/82d251d8e2dc68e6c63874904165ed5dbf8377c2.png" alt="metaq" title="metaq"></a></p>
<p>以上测试图片，来自消息测中间件试团队 @以夕 妹子的性能测试结果，更多测试结果请点击<br> <a href="http://www.atatech.org/articles/43161">Kafka、RabbitMQ、RocketMQ发送小消息性能对比</a>，<br>
<a href="http://www.atatech.org/articles/44935">Kafka vs RocketMQ――Topic数量对单机性能的影响</a>，<br>
<a href="http://www.atatech.org/articles/49733">Kafka vs RocketMQ――单机系统可靠</a>。</p>
<h2>核心功能</h2>
<p><code>MetaQ</code>作为一款消息中间件，消息中间件该有的功能，<code>MetaQ</code>也有。本文并不全面介绍<code>MetaQ</code>方面方面，只是选取性能这一角度，来剖析其高性能的原因。</p>
<h3>功能组件</h3>
<ul>
<li><p><code>MetaQ Server</code></p>
<p>最为核心的组件，它主要可以接收应用程序发送过来的消息并存储，然后再投递。</p></li>
<li><p><code>MetaQ Master</code></p>
<p>是<code>MetaQ Server</code>逻辑上的角色，和<code>MySQL Master</code>概念类型，对外提供发送消息、订阅消息以及维护着管理信息。</p></li>
<li><p><code>MetaQ Slave</code></p>
<p>是<code>MetaQ Server</code>逻辑上的角色，和<code>MySQL Slave</code>概念类型，对外提供订阅消息功能。</p></li>
<li><p><code>MetaQ Client</code></p>
<p>主要是应用程序使用，使用<code>MetaQ Client</code>来发送消息、订阅消息、其它控制信息。</p></li>
<li><p>其它无数据管理及控制信息组件</p>
<p>提供订阅关系管理功能，<code>MetaQ Server</code>服务发现功能。</p></li>
</ul>
<h3>发送消息</h3>
<p><code>MetaQ Client</code> 发送消息，<code>MetaQ Server</code>收到消息，并存储到文件系统。也就是说<code>MetaQ</code>会有大量<code>write</code>系统调用。</p>
<h3>订阅消息</h3>
<p><code>MetaQ Client</code> 订阅消息，因其是<code>Pull</code>的模型。<code>MetaQ Server</code>收到<code>Pull</code>消息的请求，会从磁盘上读取出消息，然后返回给<code>MetaQ Client</code>。这一步有大量的<code>read</code>系统调用。</p>
<h3>矛盾</h3>
<p>从上面的功能上看，<code>Metaq Server</code>要支持大量的磁盘<code>IO</code>操作，因为其是构建文件系统之上的消息中间件。既然使用了文件系统来存储数据，但磁盘<code>QPS</code>每秒也就是几百。<code>MetaQ Server</code>又必须高性能（如<code>MetaQ Server</code>性能是10W级别的QPS）,才能在可接收的成本范围内，满足业务需求(不丢消息)。如何在<code>QPS</code>只有几百的磁盘上，构建出一个高性能的<code>MetaQ</code>消息间件正是本文的中心。</p>
<h2>高性能</h2>
<p>前面介绍了<code>MetaQ</code>高性能的难点，那么我们如何解决这些难点。要解决这些难点，就必须找出这些难点。那么要写一个高性能的消息中间件，会有哪些会部分会对影响性能。</p>
<h3>影响性能的关键几点</h3>
<ul>
<li>序列化与反序列化</li>
</ul>
<p>从<code>MetaQ  Cleint</code>要发送消息，必须要先序列化，然后才能通过网络发送出去。 <code>MetaQ Server</code>收到消息后，要进行反序列化，才能解析出消息内容，最后序列化存储到文件系统。</p>
<p><code>MetaQ Client</code>收到消息，首页<code>MetaQ Server</code>必须从文件中读取消息，然后通过网络发送给<code>MetaQ Client</code>，收到消息，进行反序列化，应用才能识别消息内容。</p>
<p><code>MetaQ</code>核心功能，都要通过序列化与反序列化，所以其性能，对<code>MetaQ</code>性能有关键性的影响，其实不是对<code>MetaQ</code>,只要使用了序列化与反序列化，其对性能影响都很大。</p>
<ul>
<li><code>write</code>性能</li>
</ul>
<p>因为<code>MetaQ Server</code>会有大量的<code>write</code>系统调用 ，所以其性能对<code>MetaQ</code>性能有着重要的影响。</p>
<ul>
<li><code>read</code>性能</li>
</ul>
<p>因为<code>MetaQ Server</code>会有大量的<code>read</code>系统调用 ，所以其性能对<code>MetaQ</code>性能有着重要的影响。</p>
<ul>
<li>网络框架</li>
</ul>
<p>因为发送消息，订阅消息都必须经过网络，如果网络组件性能不好，对<code>MetaQ</code>性能有着关键的影响。</p>
<h3>如何高性能</h3>
<ul>
<li>序列化与反序列化</li>
</ul>
<p>要解决序列化与反序列化性能问题，我们就必须寻种各种序列化与反序列化技术性能对比，从而选出一个高性能的序列化与反序列化技术来作为<code>MetaQ</code>。</p>
<p>我们来看下<code>Java</code>世界可以选择的序列化与反序列化技术</p>
<p><a href="http://img1.tbcdn.cn/L1/461/1/2a0b6c9efb4b3a1d4d9a8e686e3f7d6978010ee3.png" target="_blank"><img src="http://img1.tbcdn.cn/L1/461/1/2a0b6c9efb4b3a1d4d9a8e686e3f7d6978010ee3.png" alt="ser" title="ser"></a></p>
<p><a href="http://img2.tbcdn.cn/L1/461/1/02ece6de59ab711fa6214df97e79c35341bfdd49.png" target="_blank"><img src="http://img2.tbcdn.cn/L1/461/1/02ece6de59ab711fa6214df97e79c35341bfdd49.png" alt="ser2" title="ser2"></a></p>
<p>从图中性能数据，可以看出，个人认为<code>Google</code>出品的<code>Protocol Buffers</code>应该是最佳选择，不管软件的质量、社区活跃、软件的后续发展上来说，都是不错的选择。</p>
<p>但<code>MetaQ</code>并没有选择<code>Protocol Buffers</code>作为其序列化与反序列化的技术，一个原因是<code>Protocol Buffers</code>居然在小版之间本都不兼容，<code>2.3</code>和<code>2.5</code>的版本都不兼容。这会带来一个严重的问题，如果<code>MetaQ</code>选择<code>2.3</code>的版本，应用程序选择了<code>2.5</code>，都会导致冲突，反之亦然。</p>
<p><code>MetaQ</code>消息元数据是通过<code>JSON</code>来序列化与反序列化，消息<code>Body</code>是交给应用自己序列化与反序列化。</p>
<p>虽然使用<code>Protocol Buffers</code>性能会更好，但带给用户带来麻烦。所以<code>MetaQ</code>选择使用<code>JSON</code>。</p>
<ul>
<li><code>IO</code>优化</li>
</ul>
<p>前面也已经介绍了，<code>MetaQ Server</code> 存大大量的<code>IO</code>，那么怎么优化呢？</p>
<h4><code>read</code>优化</h4>
<p><code>read</code>优化主要是使用了<a href="http://www.atatech.org/articles/47927">文件系统之读写高级篇</a>里介绍的<code>mmap</code>文件映射技术。这样可以减少系统上下文切换和复制数据的开销。更多详情见<a href="http://www.atatech.org/articles/47927">文件系统之读写高级篇</a>。</p>
<p>同时文件系统提供了文件预读的功能，也使的读取文件开销，特别是顺序读时，开销比较低。更多详情见<a href="http://www.atatech.org/articles/47927">文件系统之读写高级篇</a>。</p>
<h4><code>write</code>优化</h4>
<p>前面也介绍了，<code>write</code>可能存在并发问题，那么<code>MetaQ</code>是如何解决的？</p>
<p><code>MetaQ</code>消息只保留在一个物理文件上，所有的消息都会写一个物理文件，每个物理文件都是固定大小，超过设置的阀值后，自动创建新的一个文件。当磁盘快满时，会自动删除老的文件。</p>
<h5><code>Group Commit</code>技术</h5>
<p><code>Group Commit</code>也就是组提交，组提交是指可以多次分写请求只要通过一次刷新数据，就可以实现这些请求的数据都已刷新到磁盘上。</p>
<p><code>MySQL</code>数据库能保证<code>ACID</code>,事务提交也使用了<code>Group Commit</code>来提高性能（为了保证<code>D</code>，数据需要持久化到文件系统）。</p>
<p>详细见下图</p>
<p><a href="http://img1.tbcdn.cn/L1/461/1/0322773afcfecf84383ac1e5f6e4655a1924c089.png" target="_blank"><img src="http://img1.tbcdn.cn/L1/461/1/0322773afcfecf84383ac1e5f6e4655a1924c089.png" alt="group_commit" title="group_commit"></a></p>
<p>当<code>写请求1</code>到<code>MetaQ Server</code>时，把线程写入内核后，触发<code>flush</code>线程刷新数据到磁盘，以保证数据的可靠性。<br>
然后再向<code>MetaQ Client</code> 响应发送消息成功。这个时间，只要文件系统和磁盘不损坏，数据是不会丢失的。</p>
<p>正在<code>flush线程</code>要准备刷新数据时，<code>写请求2</code>，<code>写请求3</code>，<code>写请求4</code>也到<code>MetaQ Server</code>且写入数据，这样因<code>写请求1</code>写数据，触发的<code>flush</code>顺便也把<code>写请求2</code>，<code>写请求3</code>，<code>写请求4</code>的数据也刷新到磁盘。这样减少了刷新磁盘的次数，性能自然就高了，同时也保证的数据的可靠性。</p>
<p>如何实现<code>Group Commit</code>,请看源码</p>
<pre><code data-language="">  // Synchronization flush
        if (FlushDiskType.SYNC_FLUSH == this.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) {
            GroupCommitService service = (GroupCommitService) this.flushCommitLogService;
            if (msg.isWaitStoreMsgOK()) {
                request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());
                service.putRequest(request);
                boolean flushOK =
                        request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig()
                            .getSyncFlushTimeout());
                if (!flushOK) {
                    log.error(&quot;do groupcommit, wait for flush failed, topic: &quot; + msg.getTopic() + &quot; tags: &quot;
                            + msg.getTags() + &quot; client address: &quot; + msg.getBornHostString());
                    putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);
                }
            }
            else {
                service.wakeup();
            }
        }
        // Asynchronous flush
        else {
            this.flushCommitLogService.wakeup();
        }
</code></pre><h4>并发安全</h4>
<p><a href="http://www.atatech.org/articles/47555">文件系统之读写基础篇</a>也提到过，<code>write</code>如何保证并发安全，在写数据前，需要抢占一个锁，因为这只是把数据写到文件系统缓存中，所以持有锁的时间非常短，对性能友好。请看代码</p>
<pre><code data-language=""> synchronized (this) {
            long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();

            // Here settings are stored timestamp, in order to ensure an orderly
            // global
            msg.setStoreTimestamp(beginLockTimestamp);

            MapedFile mapedFile = this.mapedFileQueue.getLastMapedFile();
            if (null == mapedFile) {
                log.error(&quot;create maped file1 error, topic: &quot; + msg.getTopic() + &quot; clientAddr: &quot;
                        + msg.getBornHostString());
                return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, null);
            }
            result = mapedFile.appendMessage(msg, this.appendMessageCallback);
            switch (result.getStatus()) {
            case PUT_OK:
                break;
            case END_OF_FILE:
                // Create a new file, re-write the message
                mapedFile = this.mapedFileQueue.getLastMapedFile();
                if (null == mapedFile) {
                    // XXX: warn and notify me
                    log.error(&quot;create maped file2 error, topic: &quot; + msg.getTopic() + &quot; clientAddr: &quot;
                            + msg.getBornHostString());
                    return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);
                }
                result = mapedFile.appendMessage(msg, this.appendMessageCallback);
                break;
            case MESSAGE_SIZE_EXCEEDED:
                return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);
            case UNKNOWN_ERROR:
                return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);
            default:
                return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);
            }

            DispatchRequest dispatchRequest = new DispatchRequest(//
                topic,// 1
                queueId,// 2
                result.getWroteOffset(),// 3
                result.getWroteBytes(),// 4
                tagsCode,// 5
                msg.getStoreTimestamp(),// 6
                result.getLogicsOffset(),// 7
                msg.getKeys(),// 8
                /**
                 * Transaction
                 */
                msg.getSysFlag(),// 9
                msg.getPreparedTransactionOffset());// 10

            this.defaultMessageStore.putDispatchRequest(dispatchRequest);

            eclipseTimeInLock = this.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;
        } // end of synchronized
</code></pre><h3>网络性能</h3>
<p><code>MetaQ</code>的网络框架，选择了<code>Netty4</code>。<code>Netty4</code>因出色的性能和易用性，成为高性能场景的不二选择。</p>
<p>更多详细的介绍请看我<code>2014年为双11优化</code>Notify<code>性能</code>的文章，<a href="http://www.atatech.org/articles/26179">Notify优化性能及Netty实践</a>。</p>
<h2>后记</h2>
<p><code>MetaQ</code>高性能的秘密，我们从其功能结构，从功能的作用，一个个解释了可能影响性能的点，及怎么解决这些问题，提高性能。</p>
<p>虽然一个个点看起来简单，但要实现一个稳定、高性能的消息系统，还是不容易的。</p>

                      </div>

          
          <div class="_article-float hidden-xs" data-fixed="false">
            <div class="container">
              <div class="_article-float-inner">
                <aside class="_article-side">
    <a href="/articles/50240/follow" class="btn btn-primary btn-block" role="button" rel="nofollow" data-remote="true" data-method="post" data-done="$(this).parent().replaceWith(r)">关注</a>
    <section class="_article-followers">
    <h6 class="heading text-center">12人关注该文章</h6>
    <ul class="list-inline">
      <li><a href="/users/250229" class="trigger_avatar" avatar="/identicon/user/250229">福军</a></li><li><a href="/users/183320" class="trigger_avatar" avatar="http://img3.tbcdn.cn/L1/461/1/u_identicon_74919cdbe2d8b749e5cb6c8266fa538c.png_50x50">IQ</a></li><li><a href="/users/23427" class="trigger_avatar" avatar="http://img1.tbcdn.cn/L1/461/1/u_avatar_20130219174537_23427_60.jpeg_50x50">棋一</a></li><li><a href="/users/17328" class="trigger_avatar" avatar="http://img3.tbcdn.cn/L1/461/1/u_avatar_20130408135548_17328_60.jpeg_50x50">藏六</a></li><li><a href="/users/142381" class="trigger_avatar" avatar="http://img1.tbcdn.cn/L1/461/1/u_identicon_3d70f319e6794f883dde9e6be299d322.png_50x50">尘寂</a></li><li><a href="/users/65173" class="trigger_avatar" avatar="http://img2.tbcdn.cn/L1/461/1/u_identicon_8ab09aae98c8cb0f56604c23e9fb50df.png_50x50">文汇</a></li><li><a href="/users/68753" class="trigger_avatar" avatar="http://img4.tbcdn.cn/L1/461/1/img_20160511154338_50x50">银桑</a></li><li><a href="/users/201974" class="trigger_avatar" avatar="http://img2.tbcdn.cn/L1/461/1/u_identicon_f2da102b963a304432c5256bafd5fb32.png_50x50">夏石</a></li><li><a data-toggle="modal" href="/articles/50240/followers" data-target="#modal-followers" title="查看全部"><div class="img-user img-user-more text-center" style="width:26px;height:26px">...</div></a></li>    </ul>
  </section>
</aside>
              </div>
            </div>
          </div>

          <footer class="actions">
            <a href="#comment" class="btn btn-primary js-scroll-to">评论文章
                              (1)
                          </a>
            <a href="/articles/50240/voteup" title="赞" class="btn btn-default" role="button" rel="nofollow" data-remote="true" data-method="post" data-done="$(this).next().addBack().toggle();$('#voters').html(r)" >
              <span class="glyphicon glyphicon-thumbs-up"></span>
              13
            </a>
            <a href="/articles/50240/unvoteup" title="取消赞" class="btn btn-primary" role="button" rel="nofollow" data-remote="true" data-method="post" data-done="$(this).prev().addBack().toggle();$('#voters').html(r)" style="display:none">
              <span class="glyphicon glyphicon-thumbs-up"></span>
              14
            </a>
                          <button class="btn btn-default" data-toggle="modal" data-target="#modal-share" data-article-id="50240" data-share-count-target="#share-count" title="分享">
                <span class="glyphicon glyphicon-share"></span>
                <span id="share-count">0</span>
              </button>
                          
            <!-- 分享到内外工作圈 -->
            <button class="btn btn-default" data-toggle="modal" data-target="#modal-aliwork-share" data-article-id="50240" title="分享到内外工作圈">
              <span class="glyphicon glyphicon-share-alt"></span>
            </button>

            <!-- 收藏 -->
            <span id="tools_favor_footer"></span>
          </footer>
        </article>

        <hr>


        <div id="voters" js-load-url="/articles/50240/voters"></div>

                <div js-load-url="/articles/50240/similar"></div>

                  <ul class="pager _article-pager">
                          <li class="previous cnzz_block" cnzz_event="上一篇"><a href="/articles/48429">上一篇：项目版本管理思考</a></li>
                                      <li class="next cnzz_block" cnzz_event="下一篇"><a href="/articles/50612">下一篇：项目版本管理初步实践</a></li>
                      </ul>
          <hr>
        
        <section class="comments-box clearfix">
          <div class="media-list comments" id="comments" js-load-url="/articles/50240/comments">评论正在加载...</div>

          <form target="_self" accept-charset="UTF-8" action="/comments" method="POST" data-remote="true" data-target="#comments" class="js-comment-create js-active-on-valid">
            <input type="hidden" name="type" value="article">
            <input type="hidden" name="isCheck" value="1">
            <input type="hidden" name="pid" value="50240">
            <div class="form-group">
              <div class="editor js-editor">
                <div class="editor-container">
                  <div class="editor-actions">
                    <button type="button" class="btn btn-xs editor-action js-editor-fullscreen" data-original-title="全屏">
                      <span class="glyphicon glyphicon-fullscreen"></span>
                    </button>
                    <button type="button" class="btn btn-xs editor-action js-editor-preview" data-original-title="预览">
                      <span class="glyphicon glyphicon-eye-open"></span>
                    </button>
                    <button type="button" class="btn btn-xs editor-action js-editor-upload" data-original-title="插入图片">
                      <span class="glyphicon glyphicon-picture"></span>
                    </button>
                  </div><!-- /.editor-actions -->
                  <textarea name="content" rows="4" class="form-control js-mention js-auto-expand editor-content" id="comment" placeholder="写下你的评论…" required></textarea>
                </div><!-- /.editor-container -->

                <div class="editor-preview-container">
                  <div class="editor-actions">
                    <button type="button" class="btn btn-xs editor-action js-editor-preview-off" data-original-title="取消预览">
                      <span class="glyphicon glyphicon-eye-close"></span>
                    </button>
                  </div><!-- /.editor-actions -->
                  <div class="editor-preview content unsafe" data-disable-with="<span class=&quot;text-muted&quot;>loading...</span>"></div>
                </div><!-- /.editor-preview-container -->
              </div><!-- /.editor  -->
            </div>
            <div class="form-group text-right">
              <button type="submit" class="btn btn-primary" disabled>评论</button>
            </div>
          </form>
        </section><!-- /.comments -->

      </div><!-- /._article-box -->
    </div>
  </div><!-- /.container -->
        <footer class="footer" role="contentinfo">
  <div class="container">
	  <p class="copyright pull-left">
	  	? 2017 阿里巴巴集团 版权所有 Copyright? 17 ATA. All rights reserved.
      <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254194462'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/stat.php%3Fid%3D1254194462%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>	  </p>
    <ul class="list-inline pull-right">
      <li><a href="/articles/67826" target="_blank">ATA社区常见问题汇总</a></li>
    </ul>
  </div>
</footer>
<script>require('module/global')</script>
<script>
  require('module/jquery.lazyload');
  $('img[data-original]').lazyload({effect: 'fadeIn'});
</script>
    <div id="modal-followers" class="modal fade" role="dialog" aria-labelledby="followers" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">关注者</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary">分享</button>
      </div>
    </div>
  </div>
</div><!-- /#modal-share -->  <div id="modal-share" class="modal fade" role="dialog" aria-labelledby="share" aria-hidden="true">
  <div class="modal-dialog">
    <form target="_self" action="/articles/#{id}/share" method="POST" data-remote="true" data-done="$(this).closest('.modal').modal('hide');$('#share-group-or-team').selectize({plugins: ['remove_button']})[0].selectize.clear();$($(this).data('shareCountTarget')).inc();$.alert('分享成功', 'success')" class="js-active-on-valid" novalidate>
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">分享</h4>
      </div>
      <div class="modal-body">
                                    <div class="form-group">
            <label for="share-group">分享到我的团队/圈子</label>
            a
            <select name="share-group-or-team[]" id="share-group-or-team" class="form-control" autocomplete="off" placeholder="Groups or Teams" required="1" multiple>
                                    <option value="">请选择</option>
                                                                                                        <optgroup label="&nbsp;集团客户体验事业群-产品研发团队">
                                                                    <option value="tid_115_cid_531">&nbsp;&nbsp;&nbsp;&nbsp;集团客户体验事业群-产品研发团队 - 线上问题排查</option>
                                                                    <option value="tid_115_cid_532">&nbsp;&nbsp;&nbsp;&nbsp;集团客户体验事业群-产品研发团队 - 新人总结</option>
                                                                    <option value="tid_115_cid_546">&nbsp;&nbsp;&nbsp;&nbsp;集团客户体验事业群-产品研发团队 - 网络通讯</option>
                                                                    <option value="tid_115_cid_547">&nbsp;&nbsp;&nbsp;&nbsp;集团客户体验事业群-产品研发团队 - 经验贴</option>
                                                                    <option value="tid_115_cid_1171">&nbsp;&nbsp;&nbsp;&nbsp;集团客户体验事业群-产品研发团队 - 体验改进</option>
                                                                </optgroup>
                                                                                            
                                            <optgroup label="&nbsp;圈子">
                                                    <option value="gid_1376">猿来如此</option>
                                                </optgroup>
                                                </select>
        </div>
        <div class="form-group">
          <label for="share-users">分享给同事</label>
          <input type="text" name="users" class="form-control js-user-complete" id="share-users" placeholder="Users" required="1">
        </div>
        <div class="form-group">
          <textarea name="content" rows="3" class="form-control" placeholder="羞羞的内容"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary" disabled>分享</button>
      </div>
    </div>
    </form>
  </div>
</div><!-- /#modal-share -->
<script>require('modal-share')</script>
<script>
$('#share-group-or-team').selectize({
    plugins: ['remove_button']
})[0].selectize.clear();
</script>
  <div id="modal-aliwork-share" class="modal fade" role="dialog" aria-labelledby="share" aria-hidden="true">
  <div class="modal-dialog">
    <form target="_self" action="/articles/50240/sharetoaliwork" method="POST" data-remote="true" data-done="$(this).closest('.modal').modal('hide');$('#share-group-or-team').selectize({plugins: ['remove_button']})[0].selectize.clear();$($(this).data('shareCountTarget')).inc();$.alert('分享成功', 'success')" class="js-active-on-valid" novalidate>
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">分享到内外工作圈</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="share-group">消息中间件MetaQ高性能原因分析</label>
          </div>
          <div class="form-group share-detail">
            <div class="img-thumb"><img class="share-img" src="" width="60px" height="60px"></div>
            <div class="content-brief">简介
前面写了关于文件系统的三篇文章，深入浅出文件系统，文件系统之读写基础篇，文件系统之读写高级篇，此篇算是对文件系统相关文章的一个总结。
MetaQ是一款高性能的消息中间件，经过几年的发展，已经非常</div>
          </div>
          <div class="form-group">
            <textarea name="content" rows="3" class="form-control" placeholder="感谢你的分享！ 想对同学们说点什么？"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary" disabled>分享</button>
        </div>
      </div>
    </form>
  </div>
</div><!-- /#modal-share -->
<script>require('modal-share')</script>
<script>
  $(document).ready(function(){
     var imgSrc = $("._article img").attr("src");
     if (imgSrc != undefined) {
       $("#modal-aliwork-share .share-img").prop("src", imgSrc);
     }
  });
</script>
  <div id="modal-tag-history" class="modal fade" role="dialog" aria-labelledby="tag history" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">标签历史</h4>
      </div>
      <div class="modal-body">      
        <p class="text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div><!-- /#modal-share -->
  <div id="modal-article-modify-history" class="modal fade" role="dialog" aria-labelledby="article modify history" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">编辑历史</h4>
      </div>
      <div class="modal-body">      
        <p class="text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div><!-- /#modal-share -->
  
  <!-- markModal -->
  <div class="modal fade" id="my-mark-modal" tabindex="-1" role="dialog" aria-labelledby="myMarkModal" aria-hidden="true"></div>

      <link rel="stylesheet" href="/vender/lib-video-player/video.css">
    <script src="/vender/lib-video-player/bundle.js"></script>
  
  <script data-group-id="" data-user-id="65561">require('module/mention')</script>  <script data-group-id="" data-user-id="65561">require('module/user-complete')</script>  <script>require('module/tools-favor')</script>
  <script>require('module/tag-complete')</script>
  <script>require('module/editor')</script>
  <script>require('module/mark');</script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script src='/assets/swfobject_modified.js'></script>
  <script>
    // 替换文章详情页图片地址避免出现下载
    $(document).on('click', '._article .content.unsafe a, comments-box.clearfix .content.unsafe a', function(e){
      var img = $(this).children('img');
      if(img.attr('src') != $(this).attr('href') || !img.attr('src').match(/[0-9a-z]{32}$/)) {
        return true;
      }
      $(this).attr('href', '/public/imageView?src=' + img.attr('src'));
      return true;
    });

    $('.js-video').on('click', function () {
      if ($('#taobao-online-video').length > 0) {
        swfobject.registerObject("taobao-online-video");
      }
    })

    $(function () {
      $('body').append('<div id="article-outline"><div style="overflow: hidden;"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button></div></div><style>#article-outline{display:none;min-width:140p;max-width: 200px; max-height: 450px;position:absolute;top:150px;left:-999px;border:1px solid #ccc;box-shadow:5px 5px 2px #ccc;padding: 5px 10px;background-color: #fff;overflow-y: auto;scroll-x: auto;}#article-outline ul{margin:5px 0 5px 0;padding-left:30px;font-size:12px;border-left:1px dotted #ccc;}#article-outline ul:first-child{padding-left:15px;border:none;}#article-outline li{list-style-type:decimal;margin:3px 0;}</style>')
      var jOutline = $('#article-outline');

      var jContent = $('article .content');
      var jContentHeight = jContent.height();
      jOutline.find('.close').on('click', function () {
        jOutline.hide();
      })

      updateOutline();

      var top = jOutline.offset().top;
      scrollOutline();
      $(window).on('scroll', scrollOutline);
      function scrollOutline() {
        var scrollTop = $(document).scrollTop();
        var maxTop = jContent.offset().top + jContent.height() - jOutline.height();
        if (scrollTop >= top && scrollTop <= maxTop) {
          jOutline.css({'position': 'fixed', 'top': 0});
        }
        else if (scrollTop < top) {
          jOutline.css({'position': 'absolute', 'top': '150px'});
        }
        else {
          jOutline.css({'position': 'absolute', 'top': maxTop + 'px'});
        }

      }

      function updateOutline() {
        var arrAllHeader = jContent.find("h1,h2,h3,h4,h5,h6");
        var arrOutline = ['<ul>'];
        var header, headerText;
        var id = 0;
        var level = 0,
            lastLevel = 1;
        var levelCount = 0;
        for (var i = 0, c = arrAllHeader.length; i < c; i++) {
          header = arrAllHeader[i];
          headerText = $(header).text();

          header.setAttribute('id', id);

          level = header.tagName.match(/^h(\d)$/i)[1];
          levelCount = level - lastLevel;

          if (levelCount > 0) {
            for (var j = 0; j < levelCount; j++) {
              arrOutline.push('<ul>');
            }
          } else if (levelCount < 0) {
            levelCount *= -1;
            for (var j = 0; j < levelCount; j++) {
              arrOutline.push('</ul>');
            }
          }
          ;
          arrOutline.push('<li>');
          arrOutline.push('<a target="_self" href="#' + id + '">' + headerText + '</a>');
          arrOutline.push('</li>');
          lastLevel = level;

          var html = '<a target="_self" class="article-anchor" href="#'+$(header).prop("id")+'" ><svg class="octicon octicon-link ancher-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">' +
                     '<path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>'+
                     '</a>' +
                     $(header).html();
          $(header).html(html);
          id++;
        }
        arrOutline.push('</ul>')
        if (arrOutline.length > 2) {
          jOutline.append(arrOutline.join(''));
          jOutline.find('ul').each(function (i, n) {
            var jThis = $(this);
            if (jThis.children('li').length === 0) {
              jThis.replaceWith(jThis.children());
            }
          });
          showOutline();
        }
        else {
          hideOutline();
        }
      }

      // 设置锚点
      $("h1,h2,h3,h4,h5").hover(function(){
          $(this).find(".ancher-link").css({"visibility": "visible"});
        }, function(){
          $(this).find(".ancher-link").css({"visibility": "hidden"});
      });
      $("h1 .article-anchor,h2 .article-anchor,h3 .article-anchor,h4 .article-anchor,h5 .article-anchor").hover(function(){
        $(this).find(".ancher-link").css({"visibility": "visible"});
      }, function(){
        $(this).find(".ancher-link").css({"visibility": "hidden"});
      });
      function showOutline() {
        var offset = jContent.offset();

        jOutline.css({
          left: offset.left + jContent.width() + 10 + 'px',
        }).show();
      }

      function hideOutline() {
        jOutline.hide();
      }
    });
  </script>
  <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['\\$','\\$'], ["\\(","\\)"], ['$', '$'] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true,
      ignoreClass:"title"
    },
    TeX: {
      equationNumbers: { autoNumber: "AMS" }
    },
    displayAlign: "center"
  });
  </script>
<a target="_self" href="#" class="go-top" style="display:none"><span class="glyphicon glyphicon-arrow-up"></span></a>
<script>require('module/go-top')</script>  <a href="https://work.alibaba-inc.com/work/group/8401" target="_blank" title="为ATA2.0提供反馈" style="position:fixed;right:0;bottom:0px;" class="hidden-xs">
  <img src="http://gtms04.alicdn.com/tps/i4/T17D1tFrVeXXcUfo_w-30-100.png" alt="">
</a>

<script type="text/javascript">
  // CNZZ事件统计
    var _czc = _czc || [];
  $(document).on('click', '.cnzz_block a', function (e) {
      var me = $(this),
          parent = me.parents('.cnzz_block');
      var cnzz_category = $('body').attr('cnzz_category'),
          cnzz_event = parent.attr('cnzz_event'),
          cnzz_label = '',
          cnzz_value = '', // me.attr('href').replace(/^.*\/(\d+?)[^\d]*$/, '$1'),
          cnzz_nodeid = parent.attr('id') || '';

      _czc.push(["_trackEvent", cnzz_category, cnzz_event, cnzz_label, cnzz_value, cnzz_nodeid]);

      // 给cnzz留点时间, 防止数据丢失
      var t, target = me.attr('target'), h = me.attr('href');
      if (!target && $('head base[target]').length == 0 || target == '_self') {
          if (h) {
              t = setTimeout(function () {
                  clearTimeout(t);
                  return true;
              }, 300);
              return true;
          }
      }

      return true;
  });
  
  $('.form-submit-btn').click(function () {
      var form = $(this).parents('form');
      form.find('input').focus();
      form.submit();
  });
  // 导航 dropdown
  (function () {
      var t;
      $('.dropdown').hover(function () {
          var that = $(this);
          that.siblings().find('.dropdown-menu').hide();
          that.children('.dropdown-menu').show();
          clearTimeout(t);
      }, function () {
          var that = $(this);
          t = setTimeout(function () {
              that.children('.dropdown-menu').hide();
          }, 500)
      })
  }());
</script>
</body>
</html>
